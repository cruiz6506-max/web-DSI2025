{% extends 'Vistas/Vista_Admin/base_admin.html' %}

{% block title %}{% if pedido %}Editar Pedido{% else %}Nuevo Pedido{% endif %}{% endblock %}

{% block content %}
<div class="content-header">
    <h2 class="content-title">
        {% if pedido %} Editar Pedido #{{ pedido.id }}{% else %} Nuevo Pedido{% endif %}
    </h2>
</div>

<div class="form-container-large">
    <form method="POST" id="pedidoForm">
        {% csrf_token %}
        
        <!-- Informaci√≥n B√°sica -->
        <div class="form-section">
            <h3 class="section-title"> Informaci√≥n B√°sica</h3>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="cliente_id">Cliente *</label>
                    <select class="form-control" id="cliente_id" name="cliente_id" required {% if pedido %}disabled{% endif %}>
                        <option value="">Seleccione un cliente</option>
                        {% for cliente in clientes %}
                        <option value="{{ cliente.id }}" {% if pedido and pedido.usuario.id == cliente.id %}selected{% endif %}>
                            {{ cliente.nombre }} {{ cliente.apellido }} ({{ cliente.email }})
                        </option>
                        {% endfor %}
                    </select>
                    {% if pedido %}
                        <input type="hidden" name="cliente_id" value="{{ pedido.usuario.id }}">
                        <small class="form-text">No se puede cambiar el cliente en un pedido existente</small>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="tipo_pedido">Tipo de Pedido *</label>
                    <select class="form-control" id="tipo_pedido" name="tipo_pedido" required>
                        <option value="local" {% if pedido.tipo_pedido == 'local' %}selected{% endif %}> En el local</option>
                        <option value="domicilio" {% if pedido.tipo_pedido == 'domicilio' %}selected{% endif %}> Domicilio</option>
                        <option value="para_llevar" {% if pedido.tipo_pedido == 'para_llevar' %}selected{% endif %}> Para llevar</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group" id="mesa-group">
                    <label for="mesa_id">Mesa</label>
                    <select class="form-control" id="mesa_id" name="mesa_id">
                        <option value="">Sin mesa asignada</option>
                        {% for mesa in mesas_disponibles %}
                        <option value="{{ mesa.id }}" {% if pedido and pedido.mesa and pedido.mesa.id == mesa.id %}selected{% endif %}>
                            Mesa {{ mesa.numero }} (Capacidad: {{ mesa.capacidad }} personas)
                        </option>
                        {% endfor %}
                        {% if pedido and pedido.mesa %}
                        <option value="{{ pedido.mesa.id }}" selected>
                            Mesa {{ pedido.mesa.numero }} (Actual - Capacidad: {{ pedido.mesa.capacidad }})
                        </option>
                        {% endif %}
                    </select>
                    <small class="form-text">Solo para pedidos en el local</small>
                </div>

                <div class="form-group">
                    <label for="estado">Estado *</label>
                    <select class="form-control" id="estado" name="estado" required>
                        <option value="pendiente" {% if not pedido or pedido.estado == 'pendiente' %}selected{% endif %}> Pendiente</option>
                        <option value="en preparaci√≥n" {% if pedido.estado == 'en preparaci√≥n' %}selected{% endif %}> En Preparaci√≥n</option>
                        <option value="entregado" {% if pedido.estado == 'entregado' %}selected{% endif %}> Entregado</option>
                        <option value="pagado" {% if pedido.estado == 'pagado' %}selected{% endif %}> Pagado</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Productos del Pedido -->
        <div class="form-section">
            <h3 class="section-title"> Productos del Pedido</h3>
            
            <div id="productos-container">
                {% if detalles_actuales %}
                    {% for detalle in detalles_actuales %}
                    <div class="producto-row">
                        <div class="form-group" style="flex: 2;">
                            <label>Producto</label>
                            <select class="form-control producto-select" name="producto_id[]" required>
                                <option value="">Seleccione un producto</option>
                                {% for producto in productos %}
                                <option value="{{ producto.id }}" data-precio="{{ producto.precio }}" {% if producto.id == detalle.producto.id %}selected{% endif %}>
                                    {{ producto.nombre }} - ${{ producto.precio }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Cantidad</label>
                            <input type="number" class="form-control cantidad-input" name="cantidad[]" min="1" value="{{ detalle.cantidad }}" required>
                        </div>
                        <div class="form-group">
                            <label>Subtotal</label>
                            <input type="text" class="form-control subtotal-input" readonly value="${{ detalle.subtotal }}">
                        </div>
                        <button type="button" class="btn-remove-producto" onclick="removeProducto(this)">Eliminar</button>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="producto-row">
                        <div class="form-group" style="flex: 2;">
                            <label>Producto</label>
                            <select class="form-control producto-select" name="producto_id[]" required>
                                <option value="">Seleccione un producto</option>
                                {% for producto in productos %}
                                <option value="{{ producto.id }}" data-precio="{{ producto.precio }}">
                                    {{ producto.nombre }} - ${{ producto.precio }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Cantidad</label>
                            <input type="number" class="form-control cantidad-input" name="cantidad[]" min="1" value="1" required>
                        </div>
                        <div class="form-group">
                            <label>Subtotal</label>
                            <input type="text" class="form-control subtotal-input" readonly value="$0.00">
                        </div>
                        <button type="button" class="btn-remove-producto" onclick="removeProducto(this)">üóëÔ∏è</button>
                    </div>
                {% endif %}
            </div>

            <button type="button" class="btn-add-producto" onclick="addProducto()">+ Agregar Producto</button>

            <div class="total-section">
                <strong>TOTAL DEL PEDIDO:</strong>
                <span id="total-pedido" class="total-amount">$0.00</span>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn-primary">
                {% if pedido %} Actualizar Pedido{% else %} Crear Pedido{% endif %}
            </button>
            <a href="{% url 'pedidos_list' %}" class="btn-secondary"> Cancelar</a>
        </div>
    </form>
</div>

<style>
.form-container-large {
    background-color: white;
    border-radius: 10px;
    padding: 30px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    max-width: 1200px;
}

.form-section {
    margin-bottom: 40px;
    padding: 20px;
    border: 2px solid #fdd843;
    border-radius: 10px;
}

.section-title {
    font-size: 22px;
    color: #333;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid #fdd843;
}

.producto-row {
    display: flex;
    gap: 15px;
    align-items: flex-end;
    margin-bottom: 15px;
    padding: 15px;
    background-color: #f8f8f8;
    border-radius: 8px;
}

.btn-add-producto {
    background-color: #28a745;
    color: white;
    padding: 12px 25px;
    border: none;
    border-radius: 5px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    width: 100%;
    margin-top: 10px;
}

.btn-add-producto:hover {
    background-color: #218838;
    transform: translateY(-2px);
}

.btn-remove-producto {
    background-color: #dc3545;
    color: white;
    padding: 10px 15px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-bottom: 4px;
}

.btn-remove-producto:hover {
    background-color: #c82333;
}

.total-section {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 20px;
    padding: 20px;
    background-color: #fdd843;
    border-radius: 8px;
    font-size: 20px;
}

.total-amount {
    font-size: 28px;
    font-weight: bold;
    color: #ff5722;
}

.subtotal-input {
    font-weight: bold;
    color: #ff5722;
}
</style>

<script>
// Control de visibilidad de mesa seg√∫n tipo
document.getElementById('tipo_pedido').addEventListener('change', function() {
    const mesaGroup = document.getElementById('mesa-group');
    const mesaSelect = document.getElementById('mesa_id');
    
    if (this.value === 'local') {
        mesaGroup.style.display = 'block';
    } else {
        mesaGroup.style.display = 'none';
        mesaSelect.value = '';
    }
});

// Inicializar visibilidad
window.addEventListener('load', function() {
    const tipoPedido = document.getElementById('tipo_pedido').value;
    const mesaGroup = document.getElementById('mesa-group');
    
    if (tipoPedido !== 'local') {
        mesaGroup.style.display = 'none';
    }
});

// Calcular subtotal al cambiar producto o cantidad
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('producto-select') || e.target.classList.contains('cantidad-input')) {
        calcularSubtotal(e.target.closest('.producto-row'));
        calcularTotal();
    }
});

function calcularSubtotal(row) {
    const select = row.querySelector('.producto-select');
    const cantidad = row.querySelector('.cantidad-input').value;
    const subtotalInput = row.querySelector('.subtotal-input');
    
    const precio = select.options[select.selectedIndex].dataset.precio || 0;
    const subtotal = parseFloat(precio) * parseInt(cantidad || 0);
    
    subtotalInput.value = '$' + subtotal.toFixed(2);
}

function calcularTotal() {
    let total = 0;
    document.querySelectorAll('.subtotal-input').forEach(function(input) {
        const valor = input.value.replace('$', '');
        total += parseFloat(valor) || 0;
    });
    
    document.getElementById('total-pedido').textContent = '$' + total.toFixed(2);
}

function addProducto() {
    const container = document.getElementById('productos-container');
    const newRow = document.querySelector('.producto-row').cloneNode(true);
    
    // Resetear valores
    newRow.querySelector('.producto-select').selectedIndex = 0;
    newRow.querySelector('.cantidad-input').value = 1;
    newRow.querySelector('.subtotal-input').value = '$0.00';
    
    container.appendChild(newRow);
    calcularTotal();
}

function removeProducto(button) {
    const container = document.getElementById('productos-container');
    const rows = container.querySelectorAll('.producto-row');
    
    if (rows.length > 1) {
        button.closest('.producto-row').remove();
        calcularTotal();
    } else {
        alert('Debe haber al menos un producto en el pedido');
    }
}

// Calcular totales al cargar
window.addEventListener('load', function() {
    document.querySelectorAll('.producto-row').forEach(calcularSubtotal);
    calcularTotal();
});

// Validaci√≥n antes de enviar
document.getElementById('pedidoForm').addEventListener('submit', function(e) {
    const productos = document.querySelectorAll('.producto-select');
    let hayProductos = false;
    
    productos.forEach(function(select) {
        if (select.value) {
            hayProductos = true;
        }
    });
    
    if (!hayProductos) {
        e.preventDefault();
        alert(' Debe agregar al menos un producto al pedido');
        return false;
    }
    
    const accion = {% if pedido %}'actualizar'{% else %}'crear'{% endif %};
return confirm(`¬øEst√° seguro de ${accion} este pedido?`);
});
</script>
{% endblock %}